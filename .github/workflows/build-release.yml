name: ğŸ—ï¸ Build & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - prerelease

env:
  NODE_VERSION: '20.x'

jobs:
  # Build extension package
  build:
    name: ğŸ—ï¸ Build Extension
    runs-on: ubuntu-latest
    outputs:
      package-version: ${{ steps.package.outputs.version }}
      package-name: ${{ steps.package.outputs.name }}
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        npm install -g @vscode/vsce

    - name: ğŸ” Validate package.json
      run: |
        echo "ğŸ” Validating package.json..."
        node -e "
          const pkg = require('./package.json');
          console.log('âœ… Package name:', pkg.name);
          console.log('âœ… Version:', pkg.version);
          console.log('âœ… Publisher:', pkg.publisher || 'Not set');
          if (!pkg.publisher) {
            console.error('âŒ Publisher not set in package.json');
            process.exit(1);
          }
        "

    - name: ğŸ—ï¸ Compile TypeScript
      run: npm run compile

    - name: ğŸ§ª Run tests
      run: npm test

    - name: ğŸ” Run linting
      run: npm run lint

    - name: ğŸ“¦ Package extension
      id: package
      run: |
        echo "ğŸ“¦ Creating VSIX package..."
        vsce package --no-dependencies
        
        # Get package info
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        PACKAGE_NAME=$(node -p "require('./package.json').name")
        VSIX_FILE="${PACKAGE_NAME}-${PACKAGE_VERSION}.vsix"
        
        echo "version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
        echo "name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
        echo "vsix-file=${VSIX_FILE}" >> $GITHUB_OUTPUT
        
        # Verify the package was created
        if [ -f "${VSIX_FILE}" ]; then
          echo "âœ… Package created: ${VSIX_FILE}"
          ls -la *.vsix
        else
          echo "âŒ Package not found!"
          exit 1
        fi

    - name: ğŸ” Test package installation
      run: |
        echo "ğŸ” Testing package installation..."
        VSIX_FILE="${{ steps.package.outputs.name }}-${{ steps.package.outputs.version }}.vsix"
        code --install-extension "${VSIX_FILE}" --force || echo "âš ï¸ Could not test installation (VS Code not available)"

    - name: ğŸ“ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vsix-package
        path: "*.vsix"
        retention-days: 30

    - name: ğŸ“ Upload for release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts
        path: |
          *.vsix
          package.json
          README.md
          CHANGELOG.md
        retention-days: 90

  # Multi-platform compatibility test
  test-compatibility:
    name: ğŸ§ª Test Compatibility
    runs-on: ${{ matrix.os }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Compile TypeScript
      run: npm run compile

    - name: ğŸ§ª Run tests
      run: npm test
      env:
        DISPLAY: ':99'

    - name: ğŸ“¦ Test package creation
      run: |
        npm install -g @vscode/vsce
        vsce package --no-dependencies
        ls -la *.vsix

  # Create GitHub release
  create-release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [build, test-compatibility]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“ Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts
        path: ./release

    - name: ğŸ“ Generate release notes
      id: release-notes
      run: |
        VERSION="${{ needs.build.outputs.package-version }}"
        echo "ğŸš€ Generating release notes for version ${VERSION}..."
        
        # Extract changelog for this version
        if [ -f "CHANGELOG.md" ]; then
          # Get content between version headers
          awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md > release_notes.md
          
          if [ -s release_notes.md ]; then
            echo "âœ… Generated release notes from CHANGELOG.md"
          else
            echo "ğŸ“ No specific changelog found, generating basic notes..."
            echo "ğŸ‰ Release ${VERSION}" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](./CHANGELOG.md) for detailed changes." >> release_notes.md
          fi
        else
          echo "ğŸ“ No CHANGELOG.md found, generating basic notes..."
          echo "ğŸ‰ Release ${VERSION}" > release_notes.md
        fi
        
        echo "ğŸ“„ Release notes:"
        cat release_notes.md

    - name: ğŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./release/*.vsix
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to VS Code Marketplace (manual trigger or on release)
  publish-marketplace:
    name: ğŸ“¢ Publish to Marketplace
    runs-on: ubuntu-latest
    needs: [build, test-compatibility]
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta')
    environment: production
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci
        npm install -g @vscode/vsce

    - name: ğŸ—ï¸ Compile TypeScript
      run: npm run compile

    - name: ğŸš€ Publish to VS Code Marketplace
      run: vsce publish --no-dependencies
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}

    - name: âœ… Publish success notification
      run: |
        VERSION="${{ needs.build.outputs.package-version }}"
        echo "ğŸ‰ Successfully published ${VERSION} to VS Code Marketplace!"
        echo "ğŸ”— View at: https://marketplace.visualstudio.com/items?itemName=${{ secrets.PUBLISHER_NAME }}.filemet"

  # Manual version bump workflow
  version-bump:
    name: ğŸ“ˆ Version Bump
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ“ˆ Bump version
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        npm version ${{ github.event.inputs.release_type }} --no-git-tag-version
        
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "ğŸš€ Bumped version to ${NEW_VERSION}"
        
        git add package.json
        git commit -m "ğŸ”– Bump version to ${NEW_VERSION}"
        git push

    - name: ğŸ·ï¸ Create tag
      run: |
        NEW_VERSION=$(node -p "require('./package.json').version")
        git tag "v${NEW_VERSION}"
        git push origin "v${NEW_VERSION}"
        echo "ğŸ·ï¸ Created tag v${NEW_VERSION}"
